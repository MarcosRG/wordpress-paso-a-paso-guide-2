[build]
  # Comando de instalación
  base = "."

  # Comando de build - asegurar que se instalen las devDependencies necesarias para Vite
  command = "npm install --include=dev && npm run build"

  # Directorio donde se genera el build
  publish = "dist"

  # Directorio de las serverless functions
  functions = "netlify/functions"

[dev]
  # Comando de desarrollo
  command = "npm run dev:vite"
  # Puerto del servidor de desarrollo
  port = 8080
  # Configurar functions en desarrollo
  functions = "netlify/functions"

# Environment variables for build process
[build.environment]
  NODE_ENV = "production"

# Redirects para mapear rutas de API a serverless functions
[[redirects]]
  from = "/api/neon/products"
  to = "/.netlify/functions/products"
  status = 200

[[redirects]]
  from = "/api/neon/products/:id/variations"
  to = "/.netlify/functions/variations"
  status = 200

[[redirects]]
  from = "/api/neon/categories"
  to = "/.netlify/functions/categories"
  status = 200

[[redirects]]
  from = "/api/neon/diagnostic"
  to = "/.netlify/functions/neon-diagnostic"
  status = 200

# Direct function access - AGREGAR ANTES DEL CATCH-ALL
[[redirects]]
  from = "/.netlify/functions/*"
  to = "/.netlify/functions/:splat"
  status = 200
  force = true

# Redirects específicos para funciones Neon (acceso directo)
[[redirects]]
  from = "/api/neon/products*"
  to = "/.netlify/functions/neon-products:splat"
  status = 200

[[redirects]]
  from = "/api/neon/sync"
  to = "/.netlify/functions/neon-sync"
  status = 200

[[redirects]]
  from = "/api/neon/variations*"
  to = "/.netlify/functions/neon-variations:splat"
  status = 200

# Redirects para funciones MySQL ultra-rápidas
[[redirects]]
  from = "/api/mysql/bikes*"
  to = "/.netlify/functions/mysql-bikes:splat"
  status = 200

[[redirects]]
  from = "/api/mysql/test"
  to = "/.netlify/functions/mysql-test"
  status = 200

# Redirect para SPA routing (React Router) - DEVE SER O ÚLTIMO
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# Headers para CORS y seguridad
[[headers]]
  for = "/api/*"
  [headers.values]
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Headers = "Content-Type, Authorization"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"

# Variables de entorno para desarrollo
[context.development.environment]
  NODE_ENV = "development"

# Variables de entorno para producción
[context.production.environment]
  NODE_ENV = "production"
  VITE_ADMIN_USERNAME = "admin_bikesul"
  VITE_ADMIN_PASSWORD = "BikeSul2024!Admin#Secure789"
  VITE_ADMIN_EMAIL = "admin@bikesultours.com"
  VITE_ENCRYPTION_KEY = "BikeSul2024EncryptionKey!SecureKey789"
